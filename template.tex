% =========================
% CV TEMPLATE — Pandoc + Lua PMID citations
% Adds true bibliography layout for publications
% =========================

\documentclass[letterpaper,11pt]{article}

% Page geometry
\usepackage[top=0.75in, bottom=0.75in, left=0.6in, right=0.6in]{geometry}

% Font (Didot Regular)
\usepackage{fontspec}
\defaultfontfeatures{Ligatures=TeX}
\setmainfont[
  Path = fonts/,
  Extension = .ttf,
  UprightFont = {BodoniModa-Regular},
  BoldFont    = {BodoniModa-Regular},
  ItalicFont  = {BodoniModa-Italic},
  BoldFeatures   = {RawFeature={+wght=700}},
  BoldItalicFont = {BodoniModa-Italic},
  BoldItalicFeatures = {RawFeature={+wght=700}},
  Ligatures = {Common, TeX},
  Numbers = Lining,                % use lining numbers — change to OldStyle if you prefer
  Scale = 1.0
]{Bodoni Moda}

\usepackage{microtype}

% Spacing
\usepackage{setspace}
\setstretch{1.0}
\setlength{\parindent}{0pt}
\setlength{\parskip}{0pt}

% Hyperlinks
\usepackage{hyperref}
\hypersetup{
  colorlinks=true,
  urlcolor=black,
  linkcolor=black
}

\newcommand{\cvsep}{\ \textbar\ }

% Pandoc compatibility
\providecommand{\tightlist}{}

% Page-break guard using TeX primitives (no external packages)
\newcommand{\needspace}[1]{%
  \begingroup
  \dimen0=#1\relax
  \ifdim\pagegoal=\maxdimen
  \else
    \ifdim\dimexpr\pagegoal-\pagetotal<\dimen0\relax
      \pagebreak
    \fi
  \fi
  \endgroup
}

% -------------------------
% Section styling (no numbering)
% -------------------------
\setcounter{secnumdepth}{0}
\newcommand{\cvsectiontitle}[1]{%
  \begingroup
  \ifdefined\addfontfeatures
    \addfontfeatures{Letters=SmallCaps}%
    \MakeUppercase{#1}%
  \else
    \scshape\MakeUppercase{#1}%
  \fi
  \endgroup
}
\newcommand{\cvsection}[1]{%
  \needspace{6\baselineskip}%
  \vspace{12pt}%
  {\fontsize{13}{18}\selectfont\raggedright\cvsectiontitle{#1}}\par
  \vspace{3pt}\hrule\vspace{6pt}%
}
\renewcommand{\section}[1]{\cvsection{#1}}

% -------------------------
% Existing CV primitives (keep yours intact)
% -------------------------

% Fixed columns for cvrole (Title | Institution | Dates)
\newlength{\RoleW}
\newlength{\InstW}
\newlength{\DateW}
\newlength{\GutterA}
\newlength{\GutterB}
\setlength{\GutterA}{1.1em}
\setlength{\GutterB}{1.1em}
\setlength{\RoleW}{0.46\textwidth}
\setlength{\InstW}{0.34\textwidth}
\setlength{\DateW}{\dimexpr\textwidth-\RoleW-\InstW-\GutterA-\GutterB\relax}

\newenvironment{cvroles}{%
  \vspace{0pt}%
}{%
  \vspace{6pt}%
}

\newcommand{\cvrole}[3]{%
  \noindent
  \hbox to \textwidth{%
    \parbox[t]{\RoleW}{#1}%
    \hspace*{\GutterA}%
    \parbox[t]{\InstW}{\raggedright #2}%
    \hspace*{\GutterB}%
    \parbox[t]{\DateW}{\raggedleft #3}%
  }\par
}

\newcommand{\cvnote}[1]{%
  \noindent\hspace*{1.2em}{\small\textit{#1}}\par
}

% Role + notes block that should stay together
\newcommand{\cvroleblock}[4]{%
  \needspace{3\baselineskip}%
  \cvrole{#1}{#2}{#3}%
  #4%
}

% Bulletless list (no enumitem dependency)
\newenvironment{cvlist}{
  \begin{list}{}{
    \setlength{\leftmargin}{1.25em}
    \setlength{\itemsep}{0pt}
    \setlength{\parsep}{0pt}
    \setlength{\topsep}{0pt}
    \setlength{\partopsep}{0pt}
  }
}{
  \end{list}
}

\newenvironment{cvitems}{%
  \begin{list}{}{%
    \setlength{\leftmargin}{0pt}%
    \setlength{\labelwidth}{0pt}%
    \setlength{\labelsep}{0pt}%
    \setlength{\itemindent}{0pt}%
    \setlength{\itemsep}{4pt}%
    \setlength{\parsep}{0pt}%
    \setlength{\topsep}{2pt}%
  }%
}{\end{list}}

\newcommand{\cvgrant}[4]{%
  \needspace{5\baselineskip}%
  \item \textbf{#1}\par
  \textit{#2}\hfill \textbf{#3}\par
  #4
}
\newcommand{\cvlecture}[3]{\item \textbf{#1}\par #2\hfill #3}
\newcommand{\cvline}[1]{\item #1}

% Bold inline subheading used inside sections (as in cv.md)
\newcommand{\cvsubhead}[1]{%
  \needspace{3\baselineskip}%
  \textbf{#1}\par
}


% -------------------------
% True bibliography layout for publications
% -------------------------
\newlength{\pubhang}
\setlength{\pubhang}{1.8em} % tweak if desired

\newenvironment{pubs}{%
  \begin{list}{}{%
    \setlength{\leftmargin}{1.8em}%
    \setlength{\itemindent}{-1.8em}%
    \setlength{\itemsep}{4pt}%
    \setlength{\topsep}{2pt}%
    \setlength{\parsep}{0pt}%
  }%
}{\end{list}}
\newcommand{\cvpub}[1]{%
  \needspace{4\baselineskip}%
  \item \begin{samepage}#1\end{samepage}%
}

% 2-col pairs
% 2-col pairs (left label | right date)
\newlength{\PairLeftW}
\newlength{\PairRightW}
\setlength{\PairLeftW}{0.78\textwidth}
\setlength{\PairRightW}{0.22\textwidth}

\newenvironment{cvpairs}{\vspace{-2pt}}{\vspace{2pt}}
\newcommand{\cvpair}[2]{%
  \noindent
  \hbox to \textwidth{%
    \parbox[t]{\PairLeftW}{#1}%
    \parbox[t]{\PairRightW}{\raggedleft #2}%
  }\par
}

% Optional: gives TeX extra flexibility to avoid overfull boxes in dense citations
\setlength{\emergencystretch}{2em}

% -------------------------
% Header (centered, manual-style)
% -------------------------
\newcommand{\cvheader}{%
  \begin{center}
    {\fontsize{24.88}{30}\selectfont\textbf{$name$}} \\[6pt]
    $affiliation$\cvsep $address1$, $address2$ \\[3pt]
    \href{mailto:$email$}{$email$}\cvsep $phone$
  \end{center}
}

% =========================
\begin{document}

\cvheader

$body$

\end{document}
